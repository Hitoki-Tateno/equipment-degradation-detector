# 特徴量選定ドキュメント

- 日付: 2026-02-26
- ステータス: 決定済み
- 関連ADR: [analysis_ui_redesign.md](../adr/analysis_ui_redesign.md) 決定3

## 目的

Isolation Forest に渡す特徴量の種類・数を選定する。
選定結果はこのドキュメントに記録し、実装 Issue に反映する。

---

## 前提: データ特性

### 入力データ

| 項目 | 内容 |
|------|------|
| レコード構造 | `(category_id, work_time: float, recorded_at: datetime)` |
| 粒度 | 1カテゴリあたり1レコード/期間（日次〜月次、運用依存） |
| 典型的なレコード数 | 3〜100+ / カテゴリ |
| 利用可能な情報 | 作業時間（数値）、記録日時（タイムスタンプ）、カテゴリ階層 |

### 分析パイプライン

```
WorkRecord[] → FeatureBuilder.build(work_times, timestamps) → (n, d) 行列
  → IsolationForest.fit(baseline行列)
  → IsolationForest.score_samples(全行列) → anomaly_score [0, 1]
```

- ベースライン期間はユーザーが選択（正常期間を指定）
- 除外点もユーザーが選択可能
- **ベースラインのレコード数が少ない場合がある**（最低3件程度）

### 現状の特徴量

`RawWorkTimeFeatureBuilder`: work_time をそのまま (n, 1) で返す。
→ 「値の大小」のみで異常判定。変化の速さや時間パターンは捉えられない。

---

## 評価基準

| 基準 | 説明 | 重要度 |
|------|------|--------|
| **検出力向上** | raw_work_time 単独では検出できない異常パターンを捉えるか | 高 |
| **少数レコード耐性** | 10件以下のベースラインでも破綻しないか | 高 |
| **解釈容易性** | チュートリアルで説明可能か、ユーザーが効果を理解できるか | 中 |
| **パラメータの少なさ** | ユーザーが設定すべきパラメータが少ないか | 中 |
| **実装の単純さ** | NumPy のみで完結するか、追加依存が必要か | 低 |

---

## 候補一覧

### A. 時系列統計量系

#### A-1. 移動平均 (Moving Average)

| 項目 | 内容 |
|------|------|
| 概要 | 直近 window 件の work_time の平均値 |
| パラメータ | `window: int`（デフォルト: 5） |
| 出力次元 | 1 |
| 検出できるパターン | 短期ノイズを除去し、緩やかな劣化傾向を強調 |
| 少数レコード耐性 | window 未満のデータでは NaN/パディング必要。window=5 なら最低5件 |
| 懸念 | raw_work_time と相関が高い → 独立した情報量が少ない可能性 |
| 実装 | `np.convolve` または手動ループ |

**汎用異常検知の観点**: raw と MA を組み合わせると IF は「局所トレンドからの逸脱」を学習できる。
スパイク時 (raw=50, MA=12) のように raw >> MA となる状態は、raw 単独では「高い値」としか
判断されないが、MA との乖離として「コンテキスト上の異常」を捉えられる。

#### A-2. 移動標準偏差 (Moving Std)

| 項目 | 内容 |
|------|------|
| 概要 | 直近 window 件の work_time の標準偏差 |
| パラメータ | `window: int`（デフォルト: 5） |
| 出力次元 | 1 |
| 検出できるパターン | ばらつきの増大（劣化初期に作業時間が不安定化するケース） |
| 少数レコード耐性 | window 未満で NaN。window=5 なら最低5件 |
| 懸念 | 安定したデータでは常に0付近 → 情報量が乏しい |
| 実装 | 手動ループで rolling std |

**汎用異常検知の観点**: ボラティリティ変化は金融（ボリンジャーバンド等）で実績ある異常検知手法。
平均が変わらなくてもばらつきが先に増えるパターンを検出できる。

#### A-3. 変化率 (Rate of Change)

| 項目 | 内容 |
|------|------|
| 概要 | `(current - prev) / prev`（前回比パーセンテージ） |
| パラメータ | なし |
| 出力次元 | 1 |
| 検出できるパターン | 急激な増加/減少。「前回より30%増えた」等の変化を捉える |
| 少数レコード耐性 | 最初のレコードが NaN。最低2件で計算可能 |
| 懸念 | 前回値が0に近い場合に発散。ゼロ除算対策が必要 |
| 実装 | `np.diff / prev` + ゼロ除算ガード |

**汎用異常検知の観点**: 差分の正規化版。IF はカテゴリごとに独立学習するため、
カテゴリ間のスケール差を正規化する恩恵がない。差分と情報の重複が大きい。

#### A-4. 差分 (Diff)

| 項目 | 内容 |
|------|------|
| 概要 | `current - prev`（前回との絶対差） |
| パラメータ | なし |
| 出力次元 | 1 |
| 検出できるパターン | 変化の加速/減速。時系列の1階微分 |
| 少数レコード耐性 | 最初のレコードが NaN。最低2件 |
| 懸念 | 変化率とどちらが有効かはデータ依存 |
| 実装 | `np.diff` + パディング |

**汎用異常検知の観点**: 時系列分析の基本中の基本。raw では値自体が正常範囲内でも、
差分（変化速度）が異常に大きい場合を検出できる。パラメータ不要。

#### A-5. ラグ特徴量 (Lag Features)

| 項目 | 内容 |
|------|------|
| 概要 | `work_time[t-1]`, `work_time[t-2]` 等の過去値を列に追加 |
| パラメータ | `lags: int`（例: 1, 2） |
| 出力次元 | lags |
| 検出できるパターン | 時系列の自己相関。「前回も高かったら今回も高い」パターン |
| 少数レコード耐性 | lag 分のレコードが NaN。lag=2 なら最低3件 |
| 懸念 | NaN の扱い（パディング or 切り捨て）で行数が変わる |
| 実装 | `np.roll` + NaN パディング |

**汎用異常検知の観点**: diff = current - lag1 であるため、差分に情報が凝縮されている。
次元効率が悪い（lags=2 で +2次元）。差分で代替可能。

### B. 時間情報系

#### B-1. 曜日エンコーディング (Day of Week)

| 項目 | 内容 |
|------|------|
| 概要 | recorded_at の曜日を数値化（0=月〜6=日、またはサイクリック） |
| パラメータ | なし |
| 出力次元 | 1（数値）or 2（sin/cos サイクリック） |
| 検出できるパターン | 曜日固有の作業パターンからの逸脱（週末作業は異常等） |
| 少数レコード耐性 | 良好。各レコードから独立に計算 |
| 懸念 | 月次データでは無意味（毎月同じ曜日にはならない） |
| 実装 | `dt.weekday()` + optional sin/cos |

**汎用異常検知の観点**: 週次パターンのあるデータ（日次粒度）でのみ有効。粒度依存が強い。

#### B-2. 月エンコーディング (Month of Year)

| 項目 | 内容 |
|------|------|
| 概要 | recorded_at の月を数値化（サイクリック sin/cos） |
| パラメータ | なし |
| 出力次元 | 2（sin/cos） |
| 検出できるパターン | 季節性。「夏は作業時間が長い」パターンからの逸脱 |
| 少数レコード耐性 | 良好。各レコードから独立に計算 |
| 懸念 | 1年分のデータがないと学習が不十分 |
| 実装 | `dt.month` → sin/cos 変換 |

**汎用異常検知の観点**: 年間季節性を持つデータで有効。+2次元で少数データとの相性が悪い。
1年以上のデータ量が前提。

#### B-3. 経過日数 (Days Elapsed)

| 項目 | 内容 |
|------|------|
| 概要 | ベースライン開始日からの経過日数 |
| パラメータ | なし |
| 出力次元 | 1 |
| 検出できるパターン | 時間経過に伴う劣化トレンド（回帰とは独立に特徴として使える） |
| 少数レコード耐性 | 良好 |
| 懸念 | トレンド分析（線形回帰）と役割が重複する可能性 |
| 実装 | `(recorded_at - timestamps[0]).days` |

**汎用異常検知の観点**: 既存の線形回帰（slope/intercept）と完全に重複。

---

## NaN/パディング戦略

時系列特徴量では先頭レコードが計算不能になる問題がある。

| 戦略 | 説明 | 利点 | 欠点 |
|------|------|------|------|
| **0パディング** | NaN を 0 で埋める | 行数が変わらない | 0 が「変化なし」と誤解される |
| **前方伝播** | NaN を最初の有効値で埋める | 行数が変わらない | 初期データが不正確 |
| **切り捨て** | NaN 行を除去 | 正確なデータのみ | 行数が features 間で不一致 |
| **NaN をそのまま** | IsolationForest に渡す | 実装が簡単 | sklearn は NaN 非対応 |

**推奨**: **0パディング** — Isolation Forest が NaN を受け付けないため、行数を維持しつつ最も無害な値で埋める。変化率/差分では「変化なし=0」は自然。

---

## 評価の視点: 汎用異常検知

「作業時間が伸びる」というドメイン固有の文脈ではなく、
**汎用的な時系列異常検知**として各候補を評価した。

### 時系列の異常パターン分類

| 異常タイプ | 例 | raw のみで検出 |
|-----------|---|----------------|
| レベルシフト | 値が突然高くなる/低くなる | 可能 |
| スパイク/ディップ | 一時的な急激な逸脱 | 可能 |
| トレンド変化 | 変化の加速/減速 | **困難** |
| ボラティリティ変化 | ばらつきが増加/減少 | **困難** |
| コンテキスト異常 | 局所パターンからの逸脱 | **困難** |
| 季節パターン異常 | 周期パターンからの逸脱 | **困難** |

### Tier 分類

| Tier | 候補 | 対応する異常タイプ |
|------|------|------------------|
| **1（汎用基盤）** | A-4. 差分, A-2. 移動標準偏差 | トレンド変化, ボラティリティ変化 |
| **2（組み合わせ価値）** | A-1. 移動平均 | コンテキスト異常（raw との共演で効果） |
| **3（条件付き）** | B-2. 月, B-1. 曜日 | 季節パターン異常（粒度・データ量に依存） |
| **不採用** | A-3. 変化率, A-5. ラグ, B-3. 経過日数 | 他候補と重複 |

---

## 議論ポイントと結論

### Q1: どの候補を採用するか

**結論**: Tier 1 + Tier 2 を採用（差分、移動標準偏差、移動平均）。
Tier 3（季節系）は未決定。

### Q2: データ粒度による特徴量の有効性

- 日次データ → 曜日エンコーディングが有効
- 月次データ → 曜日は無意味、月エンコーディングの方が有効
- **粒度はカテゴリごとに異なる可能性がある** → 粒度非依存の特徴量を優先すべきか
- **結論（部分）**: Tier 1 + 2 はすべて粒度非依存。Tier 3 は粒度依存のため未決定。

### Q3: パラメータのデフォルト値

**結論（部分）**: 移動平均・移動標準偏差の window はデフォルト5で揃える。

window サイズとベースラインの有効データ率:

| window | 0パディング行 | ベースライン10件 | ベースライン5件 |
|--------|-------------|-----------------|----------------|
| 3 | 2行 | 80% | 60% |
| **5** | **4行** | **60%** | **20%** |
| 10 | 9行 | 10% | 0% |

window=5 は統計的安定性（自由度4）とデータ効率のバランス。
ただし UI には直接露出させず、抽象化に包む（将来の拡張余地を残す）。

### Q4: Isolation Forest の次元数制約

特徴量を増やすほど次元が増え、少数データでの学習が不安定になる。
**推奨上限**: ベースライン件数の 1/3 程度の次元数（10件なら3次元まで）。

採用候補（raw + diff + MA + std）は最大4次元。
ベースライン12件以上で安全圏。

### Q5: 従来の統計手法との関係

採用する特徴量の組み合わせが、従来の統計的異常検知手法をカバーするかを確認した。

| IF に渡す特徴量 | IF が学習する「正常分布」 | 対応する統計手法 |
|----------------|------------------------|----------------|
| raw のみ | 値の分布 | **Z-score / Robust Z-score** — 中心からの逸脱 |
| diff のみ | 変化量の分布 | **差分の Z-score** — 通常の変化速度からの逸脱 |
| raw + diff | 値 × 変化量の同時分布 | **多変量異常検知** — 値・速度の同時逸脱 |

**diff を注入することで、ロバストZ-score的な「標準線からの逸脱」検出もカバーされる。**
ベースラインの diff 分布（≈正常な変化速度）から大きく外れた変化量は、
IF によって異常としてスコアリングされる。

**IF が Z-score より優れる点**:
- Z-score はガウス分布を仮定 → IF は分布を仮定しない（ノンパラメトリック）
- Z-score は1次元で動作 → IF は多次元の同時分布で判定可能
- raw + diff + MA + std の4次元空間で、値・速度・文脈・安定性を同時に評価できる

---

## 選定結果

| 特徴量 | 採否 | パラメータ | 出力次元 | 理由 |
|--------|------|-----------|---------|------|
| raw_work_time | 既存 | なし | 1 | デフォルト。レベルシフト・スパイク検出 |
| **diff** | **採用** | なし | 1 | トレンド変化（加速/減速）の直接検出。パラメータ不要 |
| **moving_avg** | **採用** | window=5 | 1 | raw との組み合わせでコンテキスト異常を検出 |
| **moving_std** | **採用** | window=5 | 1 | ボラティリティ変化の検出 |
| rate_of_change | 不採用 | - | - | diff と重複、ゼロ除算リスク |
| lag | 不採用 | - | - | diff で代替可能、次元効率悪い |
| day_of_week | 不採用 | - | - | 粒度依存が強く汎用性がない |
| month_of_year | 不採用 | - | - | 1年以上のデータが前提、+2次元コスト |
| days_elapsed | 不採用 | - | - | 線形回帰と重複 |

### 決定事項まとめ

- **採用特徴量**: diff, moving_avg, moving_std（raw 含め最大4次元）
- **window**: MA/std ともにデフォルト5。両者で揃える
- **window の抽象化**: UIには直接露出させず、ビルダーの内部パラメータとして抽象化
- **NaN/パディング**: 0パディング（diff は「変化なし=0」、std は「ばらつきなし=0」で自然）
- **季節系（曜日・月）**: 不採用

---

## 関連: Isolation Forest ハイパーパラメータの抽象化

**ステータス: 実装済み**（Issue #93、ADR決定4）

`ModelDefinition.anomaly_params: dict | None` として抽象化済み。
デフォルト値は `anomaly.py` の `_DEFAULTS` モジュール定数で管理:

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| `n_estimators` | 100 | 決定木の数 |
| `contamination` | 0.01 | 想定される異常割合 |
| `max_samples` | "auto" | 各木に使うサンプル数 |

API層への露出は未実施（バックエンド内部の抽象化のみ）。
詳細は [ADR 決定4](../adr/analysis_ui_redesign.md) を参照。

---

## 次のアクション

1. ~~実装 Issue を作成する（特徴量ビルダー実装）~~ → 完了（#94）
2. ~~別 Issue を作成する（IF ハイパーパラメータ抽象化）~~ → 完了（#93）
