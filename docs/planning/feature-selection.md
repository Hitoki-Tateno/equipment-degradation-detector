# 特徴量選定ドキュメント

- 日付: 2026-02-26
- ステータス: 議論中
- 関連ADR: [analysis_ui_redesign.md](../adr/analysis_ui_redesign.md) 決定3

## 目的

Isolation Forest に渡す特徴量の種類・数を選定する。
選定結果はこのドキュメントに記録し、実装 Issue に反映する。

---

## 前提: データ特性

### 入力データ

| 項目 | 内容 |
|------|------|
| レコード構造 | `(category_id, work_time: float, recorded_at: datetime)` |
| 粒度 | 1カテゴリあたり1レコード/期間（日次〜月次、運用依存） |
| 典型的なレコード数 | 3〜100+ / カテゴリ |
| 利用可能な情報 | 作業時間（数値）、記録日時（タイムスタンプ）、カテゴリ階層 |

### 分析パイプライン

```
WorkRecord[] → FeatureBuilder.build(work_times, timestamps) → (n, d) 行列
  → IsolationForest.fit(baseline行列)
  → IsolationForest.score_samples(全行列) → anomaly_score [0, 1]
```

- ベースライン期間はユーザーが選択（正常期間を指定）
- 除外点もユーザーが選択可能
- **ベースラインのレコード数が少ない場合がある**（最低3件程度）

### 現状の特徴量

`RawWorkTimeFeatureBuilder`: work_time をそのまま (n, 1) で返す。
→ 「値の大小」のみで異常判定。変化の速さや時間パターンは捉えられない。

---

## 評価基準

| 基準 | 説明 | 重要度 |
|------|------|--------|
| **検出力向上** | raw_work_time 単独では検出できない異常パターンを捉えるか | 高 |
| **少数レコード耐性** | 10件以下のベースラインでも破綻しないか | 高 |
| **解釈容易性** | チュートリアルで説明可能か、ユーザーが効果を理解できるか | 中 |
| **パラメータの少なさ** | ユーザーが設定すべきパラメータが少ないか | 中 |
| **実装の単純さ** | NumPy のみで完結するか、追加依存が必要か | 低 |

---

## 候補一覧

### A. 時系列統計量系

#### A-1. 移動平均 (Moving Average)

| 項目 | 内容 |
|------|------|
| 概要 | 直近 window 件の work_time の平均値 |
| パラメータ | `window: int`（例: 3, 5） |
| 出力次元 | 1 |
| 検出できるパターン | 短期ノイズを除去し、緩やかな劣化傾向を強調 |
| 少数レコード耐性 | window 未満のデータでは NaN/パディング必要。window=3 なら最低3件 |
| 懸念 | raw_work_time と相関が高い → 独立した情報量が少ない可能性 |
| 実装 | `np.convolve` または手動ループ |

#### A-2. 移動標準偏差 (Moving Std)

| 項目 | 内容 |
|------|------|
| 概要 | 直近 window 件の work_time の標準偏差 |
| パラメータ | `window: int` |
| 出力次元 | 1 |
| 検出できるパターン | ばらつきの増大（劣化初期に作業時間が不安定化するケース） |
| 少数レコード耐性 | window 未満で NaN。window=3 なら最低3件 |
| 懸念 | 安定したデータでは常に0付近 → 情報量が乏しい |
| 実装 | 手動ループで rolling std |

#### A-3. 変化率 (Rate of Change)

| 項目 | 内容 |
|------|------|
| 概要 | `(current - prev) / prev`（前回比パーセンテージ） |
| パラメータ | なし |
| 出力次元 | 1 |
| 検出できるパターン | 急激な増加/減少。「前回より30%増えた」等の変化を捉える |
| 少数レコード耐性 | 最初のレコードが NaN。最低2件で計算可能 |
| 懸念 | 前回値が0に近い場合に発散。ゼロ除算対策が必要 |
| 実装 | `np.diff / prev` + ゼロ除算ガード |

#### A-4. 差分 (Diff)

| 項目 | 内容 |
|------|------|
| 概要 | `current - prev`（前回との絶対差） |
| パラメータ | なし |
| 出力次元 | 1 |
| 検出できるパターン | 変化率と似るが、スケール依存。大きな値の変動に強い |
| 少数レコード耐性 | 最初のレコードが NaN。最低2件 |
| 懸念 | 変化率とどちらが有効かはデータ依存 |
| 実装 | `np.diff` + パディング |

#### A-5. ラグ特徴量 (Lag Features)

| 項目 | 内容 |
|------|------|
| 概要 | `work_time[t-1]`, `work_time[t-2]` 等の過去値を列に追加 |
| パラメータ | `lags: int`（例: 1, 2） |
| 出力次元 | lags |
| 検出できるパターン | 時系列の自己相関。「前回も高かったら今回も高い」パターン |
| 少数レコード耐性 | lag 分のレコードが NaN。lag=2 なら最低3件 |
| 懸念 | NaN の扱い（パディング or 切り捨て）で行数が変わる |
| 実装 | `np.roll` + NaN パディング |

### B. 時間情報系

#### B-1. 曜日エンコーディング (Day of Week)

| 項目 | 内容 |
|------|------|
| 概要 | recorded_at の曜日を数値化（0=月〜6=日、またはサイクリック） |
| パラメータ | なし |
| 出力次元 | 1（数値）or 2（sin/cos サイクリック） |
| 検出できるパターン | 曜日固有の作業パターンからの逸脱（週末作業は異常等） |
| 少数レコード耐性 | 良好。各レコードから独立に計算 |
| 懸念 | 月次データでは無意味（毎月同じ曜日にはならない） |
| 実装 | `dt.weekday()` + optional sin/cos |

#### B-2. 月エンコーディング (Month of Year)

| 項目 | 内容 |
|------|------|
| 概要 | recorded_at の月を数値化（サイクリック sin/cos） |
| パラメータ | なし |
| 出力次元 | 2（sin/cos） |
| 検出できるパターン | 季節性。「夏は作業時間が長い」パターンからの逸脱 |
| 少数レコード耐性 | 良好。各レコードから独立に計算 |
| 懸念 | 1年分のデータがないと学習が不十分 |
| 実装 | `dt.month` → sin/cos 変換 |

#### B-3. 経過日数 (Days Elapsed)

| 項目 | 内容 |
|------|------|
| 概要 | ベースライン開始日からの経過日数 |
| パラメータ | なし |
| 出力次元 | 1 |
| 検出できるパターン | 時間経過に伴う劣化トレンド（回帰とは独立に特徴として使える） |
| 少数レコード耐性 | 良好 |
| 懸念 | トレンド分析（線形回帰）と役割が重複する可能性 |
| 実装 | `(recorded_at - timestamps[0]).days` |

---

## NaN/パディング戦略

時系列特徴量では先頭レコードが計算不能になる問題がある。

| 戦略 | 説明 | 利点 | 欠点 |
|------|------|------|------|
| **0パディング** | NaN を 0 で埋める | 行数が変わらない | 0 が「変化なし」と誤解される |
| **前方伝播** | NaN を最初の有効値で埋める | 行数が変わらない | 初期データが不正確 |
| **切り捨て** | NaN 行を除去 | 正確なデータのみ | 行数が features 間で不一致 |
| **NaN をそのまま** | IsolationForest に渡す | 実装が簡単 | sklearn は NaN 非対応 |

**推奨**: **0パディング** — Isolation Forest が NaN を受け付けないため、行数を維持しつつ最も無害な値で埋める。変化率/差分では「変化なし=0」は自然。

---

## 議論ポイント

### Q1: どの候補を採用するか

ADR の候補リストから、初期リリースに含める特徴量を選定する。
全部入れるのではなく、**効果が高く少数レコードでも安定する組み合わせ**を優先。

### Q2: データ粒度による特徴量の有効性

- 日次データ → 曜日エンコーディングが有効
- 月次データ → 曜日は無意味、月エンコーディングの方が有効
- **粒度はカテゴリごとに異なる可能性がある** → 粒度非依存の特徴量を優先すべきか

### Q3: パラメータのデフォルト値

ユーザーが設定しやすいよう、各特徴量のパラメータにはデフォルト値を定める。
例: 移動平均 window=3、ラグ lags=1

### Q4: Isolation Forest の次元数制約

特徴量を増やすほど次元が増え、少数データでの学習が不安定になる。
**推奨上限**: ベースライン件数の 1/3 程度の次元数（10件なら3次元まで）

---

## 選定結果

（議論後に記入）

| 特徴量 | 採用 | パラメータ | 理由 |
|--------|------|-----------|------|
| raw_work_time | - | - | 既存。常に含まれるデフォルト |
| | | | |

---

## 次のアクション

1. 上記の議論ポイントについて合意する
2. 選定結果をこのドキュメントに記録する
3. 実装 Issue を作成する（特徴量ビルダー実装 + チュートリアルページ）
